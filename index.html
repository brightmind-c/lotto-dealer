<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบบันทึกหวย</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f8f9fa;
      padding: 20px;
      max-width: 850px;
      margin: auto;
    }
    h1, h2 {
      margin-top: 30px;
    }
    label, input, select {
      font-size: 16px;
    }
    input[type="text"], input[type="number"] {
      width: 80px;
      margin-right: 10px;
    }
    .form-section {
      margin-bottom: 10px;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .form-group {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    button {
      padding: 6px 12px;
      font-size: 16px;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .clear-btn {
      background-color: #9e9e9e;
    }
    .delete-btn {
      background-color: #e53935;
    }
    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }
    th, td {
      padding: 6px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #e3f2fd;
    }
  </style>
</head>
<body>

<h1>ระบบบันทึกเลขหวย v06.17</h1>

<!-- ===== เลขอั้น 3 ตัว ===== -->
<div class="form-section">
  <div class="form-group">
    <strong>เลขอั้น 3 ตัว</strong>
    <input type="text" id="blocked3Input" maxlength="3" placeholder="เลข">
    <button onclick="addBlocked3Digit()">เพิ่มรายการ</button>
  </div>
</div>

<!-- ===== ซื้อเอง 3 ตัว ===== -->
<div class="form-section">
  <div class="form-group">
    <strong>ซื้อเอง 3 ตัว</strong>
    <input type="text" id="self3Input" maxlength="3" placeholder="เลข">
    <button onclick="addSelf3Digit()">เพิ่มรายการ</button>
  </div>
</div>

<!-- ===== เลขอั้น 2 ตัว ===== -->
<div class="form-section">
  <div class="form-group">
    <strong>เลขอั้น 2 ตัว</strong>
    <input type="text" id="blocked2Input" maxlength="2" placeholder="เลข">
    <label><input type="checkbox" id="blocked2Top"> บน</label>
    <label><input type="checkbox" id="blocked2Bottom"> ล่าง</label>
    <label><input type="checkbox" id="blocked2Reverse"> กลับ</label>
    <button onclick="addBlocked2Digit()">เพิ่มรายการ</button>
  </div>
</div>

<!-- ===== ซื้อเอง 2 ตัว ===== -->
<div class="form-section">
  <div class="form-group">
    <strong>ซื้อเอง 2 ตัว</strong>
    <input type="text" id="self2Input" maxlength="2" placeholder="เลข">
    <label><input type="checkbox" id="self2Top"> บน</label>
    <label><input type="checkbox" id="self2Bottom"> ล่าง</label>
    <label><input type="checkbox" id="self2Reverse"> กลับ</label>
    <button onclick="addSelf2Digit()">เพิ่มรายการ</button>
  </div>
</div>

<!-- ===== บล็อกเดิม: 3 ตัว / 2 ตัว ===== -->

<!-- ===== 3 ตัว input ===== -->
<div class="form-section">
  <div class="form-group">
    <strong>แทง 3 ตัว</strong>
    <input type="text" id="threeDigitNumber" maxlength="3" placeholder="เลข">
    <input type="number" id="threeDigitAmount" min="1" placeholder="บาท">
    <label><input type="checkbox" id="threeDigitTop"> เต็ง</label>
    <label><input type="checkbox" id="threeDigitReverse"> กลับ</label>
    <label><input type="checkbox" id="threeDigitBottom"> ล่าง</label>
    <label><input type="checkbox" id="threeDigitTod"> โต๊ด</label>
    <button onclick="addThreeDigit()">เพิ่มรายการ</button>
    <button class="clear-btn" onclick="clearThreeDigit()">Clear</button>
  </div>
</div>

<!-- ===== 2 ตัว input ===== -->
<div class="form-section">
  <div class="form-group">
    <strong>แทง 2 ตัว</strong>
    <input type="text" id="twoDigitNumber" maxlength="2" placeholder="เลข">
    <input type="number" id="twoDigitAmount" min="1" placeholder="บาท">
    <label><input type="checkbox" id="twoDigitTop"> บน</label>
    <label><input type="checkbox" id="twoDigitBottom"> ล่าง</label>
    <label><input type="checkbox" id="twoDigitReverse"> กลับ</label>
    <button onclick="addTwoDigit()">เพิ่มรายการ</button>
    <button class="clear-btn" onclick="clearTwoDigit()">Clear</button>
  </div>
</div>

<!-- ===== ตารางรายการใหม่ทั้ง 4 แบบ ===== -->
<h2>รายการเลขอั้น 3 ตัว</h2>
<table>
  <thead><tr><th>เลข</th><th>ลบ</th></tr></thead>
  <tbody id="blocked3Table"></tbody>
</table>

<h2>รายการซื้อเอง 3 ตัว</h2>
<table>
  <thead><tr><th>เลข</th><th>ลบ</th></tr></thead>
  <tbody id="self3Table"></tbody>
</table>

<h2>รายการเลขอั้น 2 ตัว</h2>
<table>
  <thead><tr><th>เลข</th><th>บน</th><th>ล่าง</th><th>ลบ</th></tr></thead>
  <tbody id="blocked2Table"></tbody>
</table>

<h2>รายการซื้อเอง 2 ตัว</h2>
<table>
  <thead><tr><th>เลข</th><th>บน</th><th>ล่าง</th><th>ลบ</th></tr></thead>
  <tbody id="self2Table"></tbody>
</table>

<!-- ===== 3 ตัว table ===== -->
<h2>รายการแทง 3 ตัว</h2>
<table>
  <thead>
    <tr>
      <th>เลขแทง</th>
      <th>เต็ง</th>
      <th>ล่าง</th>
      <th>โต๊ด</th>
      <th>ลบ</th>
    </tr>
  </thead>
  <tbody id="threeDigitTable"></tbody>
</table>

<!-- ===== 2 ตัว table ===== -->
<h2>รายการแทง 2 ตัว</h2>
<table>
  <thead>
    <tr>
      <th>เลขแทง</th>
      <th>บน</th>
      <th>ล่าง</th>
      <th>ลบ</th>
    </tr>
  </thead>
  <tbody id="twoDigitTable"></tbody>
</table>

<!-- งวดที่ -->
<h2>สร้างโพย</h2>
<div class="form-section">
  <div class="form-group">
    <label><strong>งวดที่:</strong></label>
    <input type="text" id="drawDay" maxlength="2" placeholder="วว">
    <span>/</span>
    <input type="text" id="drawMonth" maxlength="2" placeholder="ดด">
    <span>/</span>
    <input type="text" id="drawYear" maxlength="2" placeholder="ปป">
  </div>
  <div>
    <button onclick="generatePDF()">สร้างโพย pdf</button>
  </div>
</div>

<script>
function clearTwoDigit() {
  document.getElementById('twoDigitNumber').value = '';
  document.getElementById('twoDigitAmount').value = '';
  document.getElementById('twoDigitTop').checked = false;
  document.getElementById('twoDigitBottom').checked = false;
  document.getElementById('twoDigitReverse').checked = false;
}

function clearThreeDigit() {
  document.getElementById('threeDigitNumber').value = '';
  document.getElementById('threeDigitAmount').value = '';
  document.getElementById('threeDigitTop').checked = false;
  document.getElementById('threeDigitBottom').checked = false;
  document.getElementById('threeDigitTod').checked = false;
  document.getElementById('threeDigitReverse').checked = false;
}

function addTwoDigit() {
  const numberInput = document.getElementById('twoDigitNumber');
  const amountInput = document.getElementById('twoDigitAmount');
  const number = numberInput.value.trim();
  const amount = parseInt(amountInput.value.trim());
  const top = document.getElementById('twoDigitTop').checked;
  const bottom = document.getElementById('twoDigitBottom').checked;
  const reverse = document.getElementById('twoDigitReverse').checked;

  if (number.length !== 2 || isNaN(amount) || (!top && !bottom)) {
    alert("กรอกเลข 2 หลัก, จำนวนเงิน และเลือก บน/ล่าง");
    return;
  }

  const table = document.getElementById('twoDigitTable');
  const nums = new Set();
  nums.add(number);
  if (reverse && number[0] !== number[1]) {
    nums.add(number[1] + number[0]);
  }

  nums.forEach(num => {
    const row = table.insertRow();
    row.insertCell(0).innerText = num;
    row.insertCell(1).innerText = top ? amount + "฿" : "";
    row.insertCell(2).innerText = bottom ? amount + "฿" : "";
    row.insertCell(3).innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
  });

  numberInput.value = '';
  // คง checkbox เดิมไว้
}

function addThreeDigit() {
  const numberInput = document.getElementById('threeDigitNumber');
  const amountInput = document.getElementById('threeDigitAmount');
  const number = numberInput.value.trim();
  const amount = parseInt(amountInput.value.trim());
  const top = document.getElementById('threeDigitTop').checked;
  const bottom = document.getElementById('threeDigitBottom').checked;
  const tod = document.getElementById('threeDigitTod').checked;
  const reverse = document.getElementById('threeDigitReverse').checked;

  if (number.length !== 3 || isNaN(amount) || (!top && !bottom && !tod)) {
    alert("กรอกเลข 3 หลัก, จำนวนเงิน และเลือก เต็ง/ล่าง/โต๊ด");
    return;
  }

  const table = document.getElementById('threeDigitTable');
  const added = new Set();

  const row = table.insertRow();
  row.insertCell(0).innerText = number;
  row.insertCell(1).innerText = top ? amount + "฿" : "";
  row.insertCell(2).innerText = bottom ? amount + "฿" : "";
  row.insertCell(3).innerText = tod ? amount + "฿" : "";
  row.insertCell(4).innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
  added.add(number);

  if (reverse && top) {
    const chars = number.split('');
    const perms = new Set();

    const permute = (arr, m = []) => {
      if (arr.length === 0) {
        const result = m.join('');
        if (!added.has(result)) perms.add(result);
      } else {
        for (let i = 0; i < arr.length; i++) {
          let curr = arr.slice();
          let next = curr.splice(i, 1);
          permute(curr.slice(), m.concat(next));
        }
      }
    };

    permute(chars);

    perms.forEach(num => {
      const r = table.insertRow();
      r.insertCell(0).innerText = num;
      r.insertCell(1).innerText = amount + "฿";
      r.insertCell(2).innerText = "";
      r.insertCell(3).innerText = "";
      r.insertCell(4).innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
    });
  }

  numberInput.value = '';
  // คง checkbox เดิมไว้
}


// Script ส่วนเสริมใหม่

function addBlocked3Digit() {
  const num = document.getElementById('blocked3Input').value.trim();
  if (num.length !== 3) return alert("ใส่เลข 3 หลัก");
  const table = document.getElementById('blocked3Table');
  const row = table.insertRow();
  row.insertCell(0).innerText = num;
  row.insertCell(1).innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
  document.getElementById('blocked3Input').value = '';
}

function addSelf3Digit() {
  const num = document.getElementById('self3Input').value.trim();
  if (num.length !== 3) return alert("ใส่เลข 3 หลัก");
  const table = document.getElementById('self3Table');
  const row = table.insertRow();
  row.insertCell(0).innerText = num;
  row.insertCell(1).innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
  document.getElementById('self3Input').value = '';
}

function addBlocked2Digit() {
  const numInput = document.getElementById('blocked2Input');
  const num = numInput.value.trim();
  const top = document.getElementById('blocked2Top').checked;
  const bottom = document.getElementById('blocked2Bottom').checked;
  const reverse = document.getElementById('blocked2Reverse').checked;

  if (num.length !== 2 || (!top && !bottom)) return alert("ใส่เลข 2 หลักและเลือก บน/ล่าง");

  const table = document.getElementById('blocked2Table');
  const nums = new Set();
  nums.add(num);
  if (reverse && num[0] !== num[1]) nums.add(num[1] + num[0]);

  nums.forEach(n => {
    const row = table.insertRow();
    row.insertCell(0).innerText = n;
    row.insertCell(1).innerText = top ? '✔️' : '';
    row.insertCell(2).innerText = bottom ? '✔️' : '';
    row.insertCell(3).innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
  });

  numInput.value = '';
  // คง checkbox เดิมไว้
}

function addSelf2Digit() {
  const numInput = document.getElementById('self2Input');
  const num = numInput.value.trim();
  const top = document.getElementById('self2Top').checked;
  const bottom = document.getElementById('self2Bottom').checked;
  const reverse = document.getElementById('self2Reverse').checked;

  if (num.length !== 2 || (!top && !bottom)) return alert("ใส่เลข 2 หลักและเลือก บน/ล่าง");

  const table = document.getElementById('self2Table');
  const nums = new Set();
  nums.add(num);
  if (reverse && num[0] !== num[1]) nums.add(num[1] + num[0]);

  nums.forEach(n => {
    const row = table.insertRow();
    row.insertCell(0).innerText = n;
    row.insertCell(1).innerText = top ? '✔️' : '';
    row.insertCell(2).innerText = bottom ? '✔️' : '';
    row.insertCell(3).innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
  });

  numInput.value = '';
  // คง checkbox เดิมไว้
}

// ของเดิม

async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFont("Helvetica");
  doc.setFontSize(14);

  const day = document.getElementById('drawDay').value.padStart(2, '0');
  const month = document.getElementById('drawMonth').value.padStart(2, '0');
  const year = '25' + document.getElementById('drawYear').value.padStart(2, '0');
  const drawDate = `${day}/${month}/${year}`;

  // Map สำหรับ 2 ตัว
  const topMap = {}, bottomMap = {};
  document.querySelectorAll('#twoDigitTable tr').forEach(row => {
    const num = row.children[0]?.innerText.trim();
    const top = parseInt(row.children[1]?.innerText.replace('฿', '') || '0');
    const bottom = parseInt(row.children[2]?.innerText.replace('฿', '') || '0');
    if (num) {
      if (top > 0) topMap[num] = (topMap[num] || 0) + top;
      if (bottom > 0) bottomMap[num] = (bottomMap[num] || 0) + bottom;
    }
  });

  // ===== ดึงรายการเลขอั้น/ซื้อเอง 2 ตัว =====
  const getBlocked2Digits = () => {
    const list = [];
    document.querySelectorAll('#blocked2Table tr').forEach(row => {
      const num = row.children[0]?.innerText.trim();
      const isTop = row.children[1]?.innerText.includes('✔');
      const isBottom = row.children[2]?.innerText.includes('✔');
      if (num) list.push({ num, isTop, isBottom });
    });
    return list;
  };
  const getSelf2Digits = () => {
    const list = [];
    document.querySelectorAll('#self2Table tr').forEach(row => {
      const num = row.children[0]?.innerText.trim();
      const isTop = row.children[1]?.innerText.includes('✔');
      const isBottom = row.children[2]?.innerText.includes('✔');
      if (num) list.push({ num, isTop, isBottom });
    });
    return list;
  };

  const blocked2List = getBlocked2Digits();
  const self2List = getSelf2Digits();

  const expand2Digit = (n) => {
    if (n.length !== 2) return [];
    const [a, b] = n.split('');
    const set = new Set();
    set.add(`${a}${b}`);
    if (a !== b) set.add(`${b}${a}`);
    return [...set];
  };

  const highlightTop = blocked2List.flatMap(x => x.isTop ? expand2Digit(x.num) : []);
  const highlightBottom = blocked2List.flatMap(x => x.isBottom ? expand2Digit(x.num) : []);
  const highlightTopSelf = self2List.flatMap(x => x.isTop ? expand2Digit(x.num) : []);
  const highlightBottomSelf = self2List.flatMap(x => x.isBottom ? expand2Digit(x.num) : []);

  // ====== 3 ตัว ======
  const threeList = [];
  document.querySelectorAll('#threeDigitTable tr').forEach(row => {
    const num = row.children[0]?.innerText.trim();
    const top = parseInt(row.children[1]?.innerText.replace('฿', '') || '0');
    const bottom = parseInt(row.children[2]?.innerText.replace('฿', '') || '0');
    const tod = parseInt(row.children[3]?.innerText.replace('฿', '') || '0');
    if (num && (top > 0 || bottom > 0 || tod > 0)) {
      threeList.push({ num, top, bottom, tod });
    }
  });

  const getPermutations = (str) => {
    const results = new Set();
    if (str.length === 1) return [str];
    for (let i = 0; i < str.length; i++) {
      const first = str[i];
      const rest = str.slice(0, i) + str.slice(i + 1);
      for (const perm of getPermutations(rest)) {
        results.add(first + perm);
      }
    }
    return [...results];
  };

  const isInListWithPermutation = (num, list) => {
    const perms = getPermutations(num);
    return list.some(item => perms.includes(item.num));
  };

  const threeMap = {};
  threeList.forEach(({ num, top, bottom, tod }) => {
    if (!threeMap[num]) threeMap[num] = { top: 0, bottom: 0, tod: 0 };
    threeMap[num].top += top;
    threeMap[num].bottom += bottom;
    threeMap[num].tod += tod;
  });

  const sortedThreeList = Object.entries(threeMap)
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([num, values]) => {
      return {
        num,
        ...values,
        isBlocked: isInListWithPermutation(num, getBlocked3List()),
        isSelf: isInListWithPermutation(num, getSelf3List())
      };
    });

  // ===== Generate PDF Pages =====
  doc.setFontSize(14);
  doc.text(`Date: ${drawDate}`, 15, 20);
  doc.text("2 top number", 15, 28);
  draw2DigitGrid(doc, topMap, 35, highlightTop, highlightTopSelf);

  doc.addPage();
  doc.setFontSize(14);
  doc.text(`Date: ${drawDate}`, 15, 20);
  doc.text("2 bottom number", 15, 28);
  draw2DigitGrid(doc, bottomMap, 35, highlightBottom, highlightBottomSelf);

  doc.addPage();
  doc.setFontSize(14);
  doc.text(`Date: ${drawDate}`, 15, 20);
  doc.text("3 list number", 15, 28);
  draw3DigitList(doc, sortedThreeList, 35);

  doc.save(`L-Dealer_${day}-${month}-${year}.pdf`);
}


function getBlocked2Digits() {
  const list = [];
  document.querySelectorAll('#blocked2Table tr').forEach(row => {
    const num = row.children[0]?.innerText.trim();
    const isTop = row.children[1]?.innerText.includes('✔');
    const isBottom = row.children[2]?.innerText.includes('✔');
    if (num) {
      list.push({ num, isTop, isBottom });
    }
  });
  return list;
}

function getSelf2Digits() {
  const list = [];
  document.querySelectorAll('#self2Table tr').forEach(row => {
    const num = row.children[0]?.innerText.trim();
    const isTop = row.children[1]?.innerText.includes('✔');
    const isBottom = row.children[2]?.innerText.includes('✔');
    if (num) {
      list.push({ num, isTop, isBottom });
    }
  });
  return list;
}

function getBlocked3List() {
  const list = [];
  document.querySelectorAll('#blocked3Table tr').forEach(row => {
    const num = row.children[0]?.innerText.trim();
    if (num) list.push({ num });
  });
  return list;
}

function getSelf3List() {
  const list = [];
  document.querySelectorAll('#self3Table tr').forEach(row => {
    const num = row.children[0]?.innerText.trim();
    if (num) list.push({ num });
  });
  return list;
}

function draw2DigitGrid(doc, dataMap, startY, highlightTopList = [], highlightBottomList = []) {
  const cellW = 18, cellH = 18;
  const startX = 0;
  doc.setFontSize(10);

  for (let r = 0; r < 10; r++) {
    for (let c = 0; c < 10; c++) {
      const num = `${r}${c}`;
      const val = dataMap[num] !== undefined ? `${dataMap[num]}B` : '-';
      const x = startX + (c + 1) * cellW;
      const y = startY + (r + 1) * cellH;

      // กรอบหลัก
      doc.setDrawColor(0);
      doc.rect(x, y, cellW, cellH);

      // ไฮไลต์แดง: ครึ่งบน (เลขอั้น)
      if (highlightTopList.includes(num)) {
        doc.setFillColor(255, 200, 200); // สีแดงอ่อน
        doc.rect(x, y, cellW, cellH / 2, 'F');
      }

      // ไฮไลต์เหลือง: ครึ่งล่าง (ซื้อเอง)
      if (highlightBottomList.includes(num)) {
        doc.setFillColor(255, 255, 153); // สีเหลืองอ่อน
        doc.rect(x, y + cellH / 2, cellW, cellH / 2, 'F');
      }

      doc.setTextColor(0);
      doc.text(num, x + 2, y + 7);
      doc.text(val.toString(), x + 2, y + 14);
    }
  }
}

function draw3DigitList(doc, list, startY) {
  const cellH = 10;
  const headers = ["Num", "Top", "Bottom", "Tode", "Block", "Self"];
  const cellWs = [15, 15, 15, 15, 15, 15];
  const colGap = 10;

  const colWidth = cellWs.reduce((a, b) => a + b, 0);
  const leftX = 15;
  const rightX = leftX + colWidth + colGap;
  const maxRowsPerCol = Math.floor((280 - startY) / cellH); // เหลือเผื่อ footer

  let rowCount = 0;
  let colX = leftX;
  let currentY = startY;

  const drawHeader = (x, y) => {
    let xPos = x;
    headers.forEach((text, i) => {
      doc.setFillColor(227, 242, 253); // สีฟ้าอ่อน
      doc.rect(xPos, y, cellWs[i], cellH, 'F');
      doc.setTextColor(0);
      doc.text(text, xPos + 2, y + 7);
      xPos += cellWs[i];
    });
  };

  const drawRow = (x, y, row) => {
    let xPos = x;
    const values = [
      row.num,
      row.top > 0 ? row.top.toString() : '',
      row.bottom > 0 ? row.bottom.toString() : '',
      row.tod > 0 ? row.tod.toString() : '',
      '', // Block (สี)
      ''  // Self  (สี)
    ];

    values.forEach((val, i) => {
      // Block / Self สีพื้น
      if (i === 4 && row.isBlocked) {
        doc.setFillColor(255, 192, 192); // แดงอ่อน
        doc.rect(xPos, y, cellWs[i], cellH, 'F');
      } else if (i === 5 && row.isSelf) {
        doc.setFillColor(255, 246, 176); // เหลืองอ่อน
        doc.rect(xPos, y, cellWs[i], cellH, 'F');
      } else {
        doc.setDrawColor(0);
        doc.rect(xPos, y, cellWs[i], cellH);
      }

      doc.setTextColor(0);
      doc.text(val, xPos + 2, y + 7);
      xPos += cellWs[i];
    });
  };

  // เริ่มวาด
  drawHeader(colX, currentY);
  currentY += cellH;

  list.forEach((row, idx) => {
    drawRow(colX, currentY, row);
    currentY += cellH;
    rowCount++;

    if (rowCount >= maxRowsPerCol) {
      if (colX === leftX) {
        // ย้ายไปฝั่งขวา
        colX = rightX;
        currentY = startY;
        drawHeader(colX, currentY);
        currentY += cellH;
        rowCount = 0;
      } else {
        // เต็มทั้งสองคอลัมน์ ➜ เพิ่มหน้าใหม่
        doc.addPage();
        colX = leftX;
        currentY = startY;
        drawHeader(colX, currentY);
        currentY += cellH;
        rowCount = 0;
      }
    }
  });
}

</script>

</body>
</html>
