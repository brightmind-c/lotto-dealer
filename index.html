<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ระบบบันทึกหวย v05.7</title>
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background: #f8f9fa;
      padding: 20px;
      max-width: 850px;
      margin: auto;
    }
    h1, h2 {
      margin-top: 30px;
    }
    label, input, select {
      font-size: 16px;
    }
    input[type="text"], input[type="number"] {
      width: 80px;
      margin-right: 10px;
    }
    .form-section {
      margin-bottom: 10px;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .form-group {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    button {
      padding: 6px 12px;
      font-size: 16px;
      background-color: #1e88e5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .clear-btn {
      background-color: #9e9e9e;
    }
    .delete-btn {
      background-color: #e53935;
    }
    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }
    th, td {
      padding: 6px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #e3f2fd;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }
    .draw-inputs input {
      width: 50px;
      text-align: center;
    }
    .draw-inputs {
      display: flex;
      align-items: center;
      gap: 5px;
    }
  </style>
</head>
<body>

<h1>ระบบบันทึกเลขหวย</h1>

<!-- ===== 3 ตัว input ===== -->
<div class="form-section">
  <div class="form-group">
    <strong>3 ตัว</strong>
    <input type="text" id="threeDigitNumber" maxlength="3" placeholder="เลข">
    <input type="number" id="threeDigitAmount" min="1" placeholder="บาท">
    <label><input type="checkbox" id="threeDigitTop"> เต็ง</label>
    <label><input type="checkbox" id="threeDigitReverse"> กลับ</label>
    <label><input type="checkbox" id="threeDigitBottom"> ล่าง</label>
    <label><input type="checkbox" id="threeDigitTod"> โต๊ด</label>
    <button onclick="addThreeDigit()">เพิ่มรายการ</button>
    <button class="clear-btn" onclick="clearThreeDigit()">Clear</button>
  </div>
</div>

<!-- ===== 2 ตัว input ===== -->
<div class="form-section">
  <div class="form-group">
    <strong>2 ตัว</strong>
    <input type="text" id="twoDigitNumber" maxlength="2" placeholder="เลข">
    <input type="number" id="twoDigitAmount" min="1" placeholder="บาท">
    <label><input type="checkbox" id="twoDigitTop"> บน</label>
    <label><input type="checkbox" id="twoDigitBottom"> ล่าง</label>
    <label><input type="checkbox" id="twoDigitReverse"> กลับ</label>
    <button onclick="addTwoDigit()">เพิ่มรายการ</button>
    <button class="clear-btn" onclick="clearTwoDigit()">Clear</button>
  </div>
</div>

<!-- ===== 3 ตัว table ===== -->
<h2>รายการ 3 ตัว</h2>
<table>
  <thead>
    <tr>
      <th>เลขแทง</th>
      <th>เต็ง</th>
      <th>ล่าง</th>
      <th>โต๊ด</th>
      <th>ลบ</th>
    </tr>
  </thead>
  <tbody id="threeDigitTable"></tbody>
</table>

<!-- ===== 2 ตัว table ===== -->
<h2>รายการ 2 ตัว</h2>
<table>
  <thead>
    <tr>
      <th>เลขแทง</th>
      <th>บน</th>
      <th>ล่าง</th>
      <th>ลบ</th>
    </tr>
  </thead>
  <tbody id="twoDigitTable"></tbody>
</table>

<!-- งวดที่ -->
<h2>สร้างโพย</h2>
<div class="form-section">
  <div class="form-group">
    <label><strong>งวดที่:</strong></label>
    <input type="text" id="drawDay" maxlength="2" placeholder="วว">
    <span>/</span>
    <input type="text" id="drawMonth" maxlength="2" placeholder="ดด">
    <span>/</span>
    <input type="text" id="drawYear" maxlength="2" placeholder="ปป">
  </div>
  <div>
    <button onclick="generatePDF()">สร้างโพย pdf</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
  function clearTwoDigit() {
    document.getElementById('twoDigitNumber').value = '';
    document.getElementById('twoDigitAmount').value = '';
    document.getElementById('twoDigitTop').checked = false;
    document.getElementById('twoDigitBottom').checked = false;
    document.getElementById('twoDigitReverse').checked = false;
  }

  function clearThreeDigit() {
    document.getElementById('threeDigitNumber').value = '';
    document.getElementById('threeDigitAmount').value = '';
    document.getElementById('threeDigitTop').checked = false;
    document.getElementById('threeDigitBottom').checked = false;
    document.getElementById('threeDigitTod').checked = false;
    document.getElementById('threeDigitReverse').checked = false;
  }

  function addTwoDigit() {
    const number = document.getElementById('twoDigitNumber').value.trim();
    const amount = parseInt(document.getElementById('twoDigitAmount').value.trim());
    const top = document.getElementById('twoDigitTop').checked;
    const bottom = document.getElementById('twoDigitBottom').checked;
    const reverse = document.getElementById('twoDigitReverse').checked;

    if (number.length !== 2 || isNaN(amount) || (!top && !bottom)) {
      alert("กรอกเลข 2 หลัก, จำนวนเงิน และเลือก บน/ล่าง");
      return;
    }

    const table = document.getElementById('twoDigitTable');
    const nums = new Set();
    nums.add(number);
    if (reverse && number[0] !== number[1]) {
      nums.add(number[1] + number[0]);
    }

    nums.forEach(num => {
      const row = table.insertRow();
      row.insertCell(0).innerText = num;
      row.insertCell(1).innerText = top ? amount + "฿" : "";
      row.insertCell(2).innerText = bottom ? amount + "฿" : "";
      const del = row.insertCell(3);
      del.innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
    });

    clearTwoDigit();
  }

  function addThreeDigit() {
    const number = document.getElementById('threeDigitNumber').value.trim();
    const amount = parseInt(document.getElementById('threeDigitAmount').value.trim());
    const top = document.getElementById('threeDigitTop').checked;
    const bottom = document.getElementById('threeDigitBottom').checked;
    const tod = document.getElementById('threeDigitTod').checked;
    const reverse = document.getElementById('threeDigitReverse').checked;

    if (number.length !== 3 || isNaN(amount) || (!top && !bottom && !tod)) {
      alert("กรอกเลข 3 หลัก, จำนวนเงิน และเลือก เต็ง/ล่าง/โต๊ด");
      return;
    }

    const table = document.getElementById('threeDigitTable');
    const added = new Set();

    const row = table.insertRow();
    row.insertCell(0).innerText = number;
    row.insertCell(1).innerText = top ? amount + "฿" : "";
    row.insertCell(2).innerText = bottom ? amount + "฿" : "";
    row.insertCell(3).innerText = tod ? amount + "฿" : "";
    row.insertCell(4).innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
    added.add(number);

    if (reverse && top) {
      const chars = number.split('');
      const perms = new Set();

      const permute = (arr, m = []) => {
        if (arr.length === 0) {
          const result = m.join('');
          if (!added.has(result)) perms.add(result);
        } else {
          for (let i = 0; i < arr.length; i++) {
            let curr = arr.slice();
            let next = curr.splice(i, 1);
            permute(curr.slice(), m.concat(next));
          }
        }
      };

      permute(chars);

      perms.forEach(num => {
        const r = table.insertRow();
        r.insertCell(0).innerText = num;
        r.insertCell(1).innerText = amount + "฿";
        r.insertCell(2).innerText = "";
        r.insertCell(3).innerText = "";
        r.insertCell(4).innerHTML = `<button class="delete-btn" onclick="this.parentElement.parentElement.remove()">ลบ</button>`;
      });
    }

    clearThreeDigit();
  }

  async function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // ใช้ฟอนต์มาตรฐาน Helvetica (หรือทดลองเปลี่ยนเป็น THSarabun ถ้ามี)
    doc.setFont("Helvetica");
    doc.setFontSize(16);

    // วันที่งวด
    const day = document.getElementById('drawDay').value.padStart(2, '0');
    const month = document.getElementById('drawMonth').value.padStart(2, '0');
    const year = '25' + document.getElementById('drawYear').value.padStart(2, '0');
    const drawDate = `${day}/${month}/${year}`;

    // เก็บข้อมูล 2 ตัวบน/ล่าง
    const topMap = {}, bottomMap = {};
    document.querySelectorAll('#twoDigitTable tr').forEach(row => {
      const num = row.children[0]?.innerText.trim();
      const top = parseInt(row.children[1]?.innerText.replace('฿', '') || '0');
      const bottom = parseInt(row.children[2]?.innerText.replace('฿', '') || '0');
      if (num) {
        if (top > 0) topMap[num] = (topMap[num] || 0) + top;
        if (bottom > 0) bottomMap[num] = (bottomMap[num] || 0) + bottom;
      }
    });

    // เก็บข้อมูล 3 ตัว
    const threeList = [];
    document.querySelectorAll('#threeDigitTable tr').forEach(row => {
      const num = row.children[0]?.innerText.trim();
      const top = row.children[1]?.innerText ? parseInt(row.children[1].innerText.replace('฿', '') || '0') : 0;
      const bottom = row.children[2]?.innerText ? parseInt(row.children[2].innerText.replace('฿', '') || '0') : 0;
      const tod = row.children[3]?.innerText ? parseInt(row.children[3].innerText.replace('฿', '') || '0') : 0;
      if (num && (top > 0 || bottom > 0 || tod > 0)) {
        threeList.push({ num, top, bottom, tod });
      }
    });

    // --- สร้าง pdf หน้าแรก 2 ตัวบน ---
    doc.text(`งวดที่ ${drawDate}`, 15, 20);
    doc.setFontSize(14);
    doc.text("2 ตัวบน", 15, 28);
    draw2DigitGrid(doc, topMap, 35);

    // --- หน้า 2: 2 ตัวล่าง ---
    doc.addPage();
    doc.text(`งวดที่ ${drawDate}`, 15, 20);
    doc.setFontSize(14);
    doc.text("2 ตัวล่าง", 15, 28);
    draw2DigitGrid(doc, bottomMap, 35);

    // --- หน้า 3: 3 ตัวรายการ ---
    doc.addPage();
    doc.text(`งวดที่ ${drawDate}`, 15, 20);
    doc.setFontSize(14);
    doc.text("3 ตัว", 15, 28);
    draw3DigitList(doc, threeList, 35);

    doc.save(`โพยหวย_${day}-${month}-${year}.pdf`);
  }

  // ฟังก์ชันวาดตาราง 2 ตัว 10x10 ช่อง
  function draw2DigitGrid(doc, dataMap, startY) {
    const cellW = 18, cellH = 18;
    const startX = 15;
    doc.setFontSize(10);

    // หัวตารางหลักสิบ (แถวบน)
    doc.setDrawColor(0);
    doc.setFillColor(230, 242, 253);
    doc.rect(startX, startY, cellW, cellH, "F");
    doc.text("", startX + 2, startY + 12);
    for (let c = 0; c < 10; c++) {
      doc.rect(startX + (c+1)*cellW, startY, cellW, cellH, "F");
      doc.text(c.toString(), startX + (c+1)*cellW + 6, startY + 12);
    }

    // หัวตารางหลักหน่วย (คอลัมน์ซ้าย)
    for (let r = 0; r < 10; r++) {
      doc.rect(startX, startY + (r+1)*cellH, cellW, cellH, "F");
      doc.text(r.toString(), startX + 6, startY + (r+1)*cellH + 12);
    }

    // ตารางข้อมูลและกรอบ
    for (let r = 0; r < 10; r++) {
      for (let c = 0; c < 10; c++) {
        const num = `${r}${c}`;
        const val = dataMap[num] !== undefined ? `${dataMap[num]}฿` : '-';
        const x = startX + (c+1)*cellW;
        const y = startY + (r+1)*cellH;
        doc.rect(x, y, cellW, cellH);
        doc.text(num, x + 2, y + 7);
        doc.text(val.toString(), x + 2, y + 14);
      }
    }
  }

  // ฟังก์ชันวาดรายการ 3 ตัว แบบลิสต์
  function draw3DigitList(doc, list, startY) {
    doc.setFontSize(10);
    const startX = 15;
    const lineHeight = 7;
    const colWidths = [25, 25, 25, 25];
    const headers = ["เลขแทง", "เต็ง", "ล่าง", "โต๊ด"];

    // หัวตาราง
    let x = startX;
    headers.forEach((h, i) => {
      doc.setFillColor(230, 242, 253);
      doc.rect(x, startY, colWidths[i], lineHeight, "F");
      doc.setDrawColor(0);
      doc.rect(x, startY, colWidths[i], lineHeight);
      doc.text(h, x + 3, startY + 5);
      x += colWidths[i];
    });

    // ข้อมูลแต่ละแถว
    let y = startY + lineHeight;
    list.forEach(row => {
      x = startX;
      const cells = [row.num, row.top ? row.top + "฿" : "", row.bottom ? row.bottom + "฿" : "", row.tod ? row.tod + "฿" : ""];
      cells.forEach((cell, i) => {
        doc.rect(x, y, colWidths[i], lineHeight);
        doc.text(cell.toString(), x + 3, y + 5);
        x += colWidths[i];
      });
      y += lineHeight;

      // ถ้าเกินหน้ากระดาษ ให้ขึ้นหน้าใหม่
      if (y + lineHeight > 280) {
        doc.addPage();
        y = 15;
      }
    });
  }

</script>

</body>
</html>